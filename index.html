<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendPulse | Prioritized Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Thêm DOMPurify cho bảo mật XSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23A100FF'/></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-color: #0F1021; --surface-color: #191a2e; --primary-color: #A100FF;
            --primary-light: #b540ff; --text-color: #e3e8f0; --text-muted-color: #8a8da0;
            --border-color: #2d2e49; --header-height: 65px;
            --success-color: #4CAF50; /* Màu xanh lá cho thành công */
            --danger-color: #f44336;   /* Màu đỏ cho lỗi/nguy hiểm */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; }
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .loader-overlay.loader-hidden { opacity: 0; visibility: hidden; }
        @keyframes pulse { 0% { top: 36px; left: 36px; width: 0; height: 0; opacity: 1; } 100% { top: 0px; left: 0px; width: 72px; height: 72px; opacity: 0; } }
        .loader-pulse { display: inline-block; position: relative; width: 80px; height: 80px; }
        .loader-pulse div { position: absolute; border: 4px solid var(--primary-light); opacity: 1; border-radius: 50%; animation: pulse 1.2s cubic-bezier(0, 0.2, 0.8, 1) infinite; }
        .loader-pulse div:nth-child(2) { animation-delay: -0.6s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; height: var(--header-height); animation: fadeIn 0.5s ease-out; }
        .logo { font-size: 1.8rem; font-weight: 700; cursor: pointer; }
        .logo-trend { color: var(--primary-light); }
        .nav-links { display: flex; gap: 1.5rem; list-style: none; }
        .nav-links a { color: var(--text-muted-color); text-decoration: none; font-weight: 500; transition: color 0.3s ease; padding-bottom: 4px; border-bottom: 2px solid transparent; }
        .nav-links a:hover { color: var(--primary-color); }
        .nav-links a.active-link { color: var(--text-color); border-bottom-color: var(--primary-color); }
        .nav-actions { position: relative; display: flex; align-items: center; gap: 0.75rem; }
        .hamburger-menu { display: none; }
        .btn { padding: 0.6rem 1.2rem; border: 1px solid transparent; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-secondary { background: var(--surface-color); color: var(--text-muted-color); border: 1px solid var(--border-color); }
        .btn-outline { background: transparent; color: var(--primary-light); border: 1px solid var(--primary-light); font-size: 0.8rem; padding: 0.3rem 0.8rem; }
        .btn-outline:hover { background: var(--primary-light); color: white; }
        .analyze-trend-btn { margin-right: 0.5rem; }
        .main-container { display: grid; grid-template-columns: 320px 1fr; gap: 2rem; padding: 2rem; width: 100%; max-width: 1400px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .for-u-container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; padding: 2rem; width: 100%; max-width: 1400px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .trending-board-container { padding: 2rem; width: 100%; max-width: 1400px; margin: auto; animation: slideInUp 0.6s ease-out; }
        .demo-banner { grid-column: 1 / -1; background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .trending-container, .for-u-content, .leaderboard-panel, #search-filter-panel { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .trending-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .trending-title-group { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 600; }
        .filter-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.75rem; /* Tăng khoảng cách giữa các nút */
            margin-bottom: 2rem; 
        }
        .filter-btn { 
            /* CẬP NHẬT: Phong cách mặc định */
            background-color: var(--surface-color); /* Nền tối hơn, phù hợp với theme */
            border: 1px solid var(--border-color); /* Viền tinh tế */
            color: var(--text-color); /* Chữ màu sáng */
            padding: 0.6rem 1.2rem; /* Tăng padding */
            border-radius: 8px; /* Bo tròn góc hơn */
            cursor: pointer; 
            font-weight: 500; /* Làm mỏng chữ hơn một chút */
            transition: all 0.2s ease; /* Transition mượt mà hơn */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Thêm shadow nhẹ */
        }
        .filter-btn:hover { 
            /* CẬP NHẬT: Hiệu ứng hover */
            background-color: var(--border-color); /* Nền hơi sáng lên một chút khi hover */
            border-color: var(--primary-light); /* Viền màu primary-light */
            color: var(--primary-light); /* Chữ màu primary-light */
            transform: translateY(-2px); /* Nâng nhẹ nút lên */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Shadow rõ hơn */
        }
        .filter-btn.active { 
            /* Giữ nguyên, vì nó đã trông đẹp rồi */
            background-color: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color); 
            box-shadow: 0 4px 10px rgba(161,0,255,0.3); /* Shadow đặc biệt cho active */
        }
        .trend-card { background-color: var(--bg-color); padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: slideInUp 0.5s ease-out forwards; opacity: 0; }
        .trend-card.animated { opacity: 1; } /* Class for animating cards */
        .trend-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        /* NEW: Added flex for header */
        .trend-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .trend-title { flex-grow: 1; font-size: 1.25rem; font-weight: 600; cursor: pointer; transition: color 0.3s; margin-bottom: 0.5rem; }
        .trend-title:hover { color: var(--primary-light); }
        .trend-description { margin-bottom: 1rem; color: var(--text-muted-color); }
        /* NEW: Styles for trend metadata */
        .trend-meta { font-size: 0.85rem; color: var(--text-muted-color); text-align: right; }
        .trend-meta-submitter { font-weight: 500; }
        .trend-meta-date { display: block; font-size: 0.75rem; }

        .loading-spinner { width: 20px; height: 20px; border: 2px solid rgba(161, 0, 255, 0.1); border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-status-indicator { position: fixed; top: 80px; right: 20px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem 1rem; font-size: 0.8rem; z-index: 1001; }
        .ai-status-indicator.online { border-color: var(--success-color); color: var(--success-color); }
        .ai-status-indicator.offline { border-color: var(--danger-color); color: var(--danger-color); }
        .trend-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .trend-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .tag { 
            padding: 0.25rem 0.75rem; 
            border-radius: 999px; 
            font-size: 0.8rem; 
            font-weight: 500; 
            transition: all 0.2s ease; /* Thêm transition */
        }
        .tag.category { background-color: var(--primary-color); color: white; }
        .tag.hashtag { 
            background-color: var(--surface-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-muted-color); 
            cursor: pointer; 
        }
        .tag.hashtag:hover { /* Hiệu ứng hover cho hashtag */
            background-color: var(--border-color);
            border-color: var(--primary-light);
            color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .trend-actions { display: flex; align-items: center; gap: 1rem; }
        .btn-follow { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted-color); }
        .btn-follow.followed { background-color: var(--primary-color); color: white; }

        /* NEW: Style for the new Summary button - CẬP NHẬT để giống .btn-outline */
        .btn-summary { 
            background: transparent; /* Nền trong suốt */
            color: var(--primary-light); /* Màu chữ tím nhạt */
            border: 1px solid var(--primary-light); /* Viền tím nhạt */
            padding: 0.3rem 0.8rem; /* Match btn-outline padding */
            border-radius: 8px; /* Match btn padding */
            cursor: pointer; 
            font-weight: 600; /* Match btn-outline font-weight */
            transition: all 0.3s ease; /* Match btn-outline transition */
            font-size: 0.8rem; /* Match btn-outline font-size */
        }
        .btn-summary:hover {
            /* Hiệu ứng hover giống hệt .btn-outline */
            background: var(--primary-light); 
            color: white; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Giữ bóng đổ nếu muốn */
            transform: translateY(-1px); /* Nâng nhẹ hơn để subtle hơn */
        }

        #trends-footer { text-align: center; margin-top: 1.5rem; }
        .leaderboard-panel h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; }
        .leaderboard-widget { margin-bottom: 2rem; }
        .leaderboard-widget h4 { color: var(--primary-light); margin-bottom: 1rem; font-size: 1rem; font-weight: 600; }
        .leaderboard-widget ul { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.5rem; }
        .leaderboard-widget li { background-color: var(--bg-color); padding: 0.75rem 1rem; border-radius: 6px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s ease; cursor: pointer; }
        .leaderboard-widget li:hover { background-color: var(--border-color); }

        /* NEW: Hover effects for the Trending Board lists */
        .tb-leaderboard-list li {
            transition: all 0.2s ease-in-out; /* Làm mượt hiệu ứng chuyển đổi */
            cursor: pointer; /* Đảm bảo con trỏ chuột thay đổi để báo hiệu có thể click */
        }

        .tb-leaderboard-list li:hover {
            background-color: var(--border-color); /* Thay đổi màu nền khi hover */
            transform: translateY(-2px); /* Nâng nhẹ mục lên trên */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Thêm bóng đổ nhẹ */
        }

        .view-source-btn, .btn-follow { display: inline-flex; } /* ALWAYS SHOW if logged in and is work */
        /* Removed the specific body.work-account-view rule as it's implied now */
        .dropdown { display: none; position: absolute; top: 110%; right: 0; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; min-width: 250px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; }
        .dropdown.show { display: block; }
        .dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--text-color); text-decoration: none; cursor: pointer; }
        .dropdown-item:hover { background-color: var(--border-color); }
        #search-filter-panel h3 { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        #search-input { width: 100%; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 0.75rem; border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem; }
        #hashtag-filter { margin-top: 1rem; }
        #hashtag-filter h4 { color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 1rem; }
        #hashtag-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .hashtag-btn { 
            background-color: var(--bg-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-muted-color); 
            padding: 0.25rem 0.75rem; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .hashtag-btn:hover { /* Hiệu ứng hover cho hashtag buttons trong filter */
            border-color: var(--primary-light); 
            color: var(--primary-light); 
            background-color: var(--surface-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .hashtag-btn.active { 
            border-color: var(--primary-color); 
            color: var(--primary-light); 
            background-color: var(--surface-color);
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 16, 33, 0.85); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; position: relative; border: 1px solid var(--border-color); transform: scale(0.95) translateY(10px); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .modal-overlay.show .modal-content { transform: scale(1) translateY(0); opacity: 1; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted-color); font-size: 1.5rem; cursor: pointer; }
        .modal-title { font-size: 1.5rem; margin-bottom: 1rem; }
        .modal-body { margin-bottom: 1.5rem; color: var(--text-muted-color); }
        /* NEW: Style for error messages */
        .modal-body.error-message { color: var(--danger-color); }

        #login-choice-modal .modal-content { max-width: 420px; }
        #login-choice-modal .modal-title { color: var(--primary-light); font-size: 1.75rem; margin-bottom: 0.5rem; }
        #login-choice-modal .modal-body { margin-bottom: 2rem; font-size: 0.9rem; }
        /* Cập nhật các nút đăng nhập để chỉ có SVG và span trống */
        #login-choice-modal .btn-social { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; text-align: center; font-size: 0.95rem; font-weight: 500; position: relative; }
        #login-choice-modal .btn-social:hover { border-color: var(--primary-color); background-color: #21233a; }
        #login-choice-modal .btn-social svg { position: absolute; left: 1.5rem; stroke: var(--text-muted-color); width: 20px; height: 20px; }
        .preferences-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: left; margin-bottom: 1.5rem; }
        #ai-insight-modal .modal-content { max-width: 550px; width: 90%; text-align: left; }
        #ai-insight-modal .modal-body { 
            max-height: 70vh; 
            overflow-y: auto; 
            padding-right: 15px; 
            line-height: 1.8; /* Dễ đọc hơn */
            text-align: left; /* Đảm bảo căn trái */
        }
        #ai-insight-modal h4 { 
            color: var(--primary-light); 
            margin-top: 1.5rem; /* Khoảng cách trên lớn hơn cho các phần chính */
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color); /* Đường kẻ dưới tiêu đề */
            padding-bottom: 0.5rem;
        }

        /* NEW: Styles for AI Deep Dive content */
        #ai-insight-modal h5 { /* For sub-sections */
            color: var(--text-color);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        #ai-insight-modal p {
            margin-bottom: 1rem;
            color: var(--text-muted-color);
        }

        #ai-insight-modal ul {
            list-style-type: disc; /* Kiểu dấu đầu dòng */
            padding-left: 25px;
            margin-bottom: 1rem;
            color: var(--text-color); /* Màu chữ cho danh sách */
        }

        #ai-insight-modal li {
            margin-bottom: 0.5rem;
            color: var(--text-muted-color); /* Màu chữ cho item trong danh sách */
        }

        #ai-insight-modal strong {
            color: var(--primary-light); /* Làm nổi bật văn bản in đậm */
        }

        /* Specific styles for AI Insight Sections */
        .ai-section {
            background-color: var(--bg-color); /* Nền nhẹ nhàng cho từng phần */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .ai-highlight {
            color: var(--primary-light);
            font-weight: 700;
        }

        .ai-metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            /* NEW: Center the grid items horizontally */
            justify-content: center; 
        }

        .ai-metric-item {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
        }

        .ai-metric-item strong {
            display: block;
            font-size: 1.2rem;
            color: var(--text-color);
        }

        .ai-metric-item span {
            font-size: 0.8rem;
            color: var(--text-muted-color);
        }
        /* End NEW AI Deep Dive styles */


        .tb-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .tb-search-container { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .tb-search-box { flex: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; display: flex; align-items: center; }
        .tb-search-box.compare { background-color: var(--surface-color); }
        .tb-search-box input { background: transparent; border: none; color: var(--text-color); font-size: 1rem; width: 100%; outline: none; }
        .tb-search-box.compare input::placeholder { color: var(--text-muted-color); }
        .tb-search-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; } /* Added flex-wrap */
        .tb-search-chip { background-color: var(--bg-color); border: 1px solid var(--primary-color); color: var(--primary-light); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.25rem; }
        .tb-search-chip-remove { background: none; border: none; color: var(--text-muted-color); cursor: pointer; font-size: 1rem; margin-left: 0.5rem; }
        .tb-search-chip-remove:hover { color: var(--primary-light); }

        /* Cập nhật các bộ lọc để có giao diện gọn gàng hơn */
        .tb-filters { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 1rem; 
        }

        /* Đảm bảo các select boxes vẫn trông đẹp */
        .tb-filter-select, #tb-status-select, #tb-custom-timeframe-select, #main-region-filter, #main-timeframe-filter, #main-source-filter {
            background-color: var(--bg-color); 
            border: 1px solid var(--border-color); 
            color: var(--text-color); 
            padding: 0.5rem 1rem; 
            border-radius: 8px; 
            font-size: 0.9rem;
            appearance: none; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e3e8f0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); 
            background-repeat: no-repeat;
            background-position-x: 95%;
            background-position-y: center;
            cursor: pointer;
        }

        /* NEW: Styles for main view additional filters */
        #main-view-additional-filters {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Giảm khoảng cách giữa các bộ lọc */
        }
        #main-view-additional-filters h4 {
            margin-bottom: 0.25rem; /* Giảm khoảng cách với select bên dưới */
        }


        @media (max-width: 768px) {
            .tb-filters {
                grid-template-columns: 1fr; 
            }
        }


        .tb-leaderboards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem; }
        .tb-leaderboard { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        .tb-leaderboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--text-muted-color); font-size: 0.9rem; }
        .tb-leaderboard-list ol { list-style: none; padding: 0; }
        .tb-leaderboard-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); font-weight: 500; }
        .tb-leaderboard-list li:last-child { border-bottom: none; }
        .tb-leaderboard-list .rank { color: var(--text-muted-color); margin-right: 1rem; }
        .tb-leaderboard-list .term { flex-grow: 1; }
        .tb-leaderboard-list .growth { color: var(--success-color); }
        #tb-chart-container { margin-top: 2rem; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; }
        /* CẬP NHẬT: Giới hạn chiều cao biểu đồ */
        #tb-chart-container canvas { width: 100%; max-height: 350px; }
        /* NEW CHART CONTAINER STYLE */
        #user-trends-chart-container {
            margin-top: 2rem;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }
        #user-trends-chart-container canvas {
            width: 100%;
            max-height: 350px;
        }

        /* NEW: Style for the Trend Overview Modal */
        #trend-overview-modal .modal-content {
            max-width: 600px; /* Adjust max width as needed */
            width: 90%;
            text-align: left;
            padding: 1.5rem; /* Match trend-card padding */
        }

        /* Make sure inner elements match trend-card styles */
        #trend-overview-modal #trend-overview-body .trend-card-header {
            margin-bottom: 0.5rem; /* Adjust if needed */
        }
        #trend-overview-modal #trend-overview-body .trend-description {
            margin-bottom: 1rem;
        }
        #trend-overview-modal #trend-overview-body .trend-tags {
            margin-bottom: 1rem;
        }
        #trend-overview-modal #trend-overview-body .trend-footer {
            border-top: 1px solid var(--border-color); /* Add a separator if desired */
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .footer { background-color: var(--surface-color); border-top: 1px solid var(--border-color); padding: 3rem 0 1rem 0; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-title { color: var(--primary-light); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
        .footer-links { list-style: none; padding: 0; }
        .footer-links a { color: var(--text-muted-color); text-decoration: none; }
        .footer-links a:hover { color: var(--primary-light); }
        .footer-bottom { border-top: 1px solid var(--border-color); margin-top: 2rem; padding-top: 1.5rem; text-align: center; color: var(--text-muted-color); font-size: 0.9rem; }
        @media (max-width: 1024px) { .main-container, .for-u-container { grid-template-columns: 1fr; } #search-filter-panel, .leaderboard-panel { grid-row: 1; }
            /* NEW: Adjust dropdown position for smaller screens */
            .nav-actions .dropdown { right: 1rem; left: auto; }
        }
        @media (max-width: 768px) {
            .header { padding: 0 1rem; }
            .nav-links { position: fixed; top: var(--header-height); left: 0; width: 100%; height: calc(100vh - var(--header-height)); background-color: var(--bg-color); flex-direction: column; align-items: center; padding-top: 2rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            nav.nav-active .nav-links { transform: translateX(0); }
            .hamburger-menu { display: flex; flex-direction: column; justify-content: space-around; width: 2rem; height: 2rem; background: transparent; border: none; cursor: pointer; z-index: 10; }
            .hamburger-menu.active span:nth-child(1) { transform: translateY(0.875rem) rotate(45deg); } /* Adjusted transform origin */
            .hamburger-menu.active span:nth-child(2) { opacity: 0; }
            .hamburger-menu.active span:nth-child(3) { transform: translateY(-0.875rem) rotate(-45deg); } /* Adjusted transform origin */
            .main-container, .for-u-container, .trending-board-container { padding: 1rem; }
            .trending-title-group { font-size: 1.25rem; }
            .trend-card { padding: 1rem; }
            .trend-title { font-size: 1.1rem; }
            .tb-leaderboards-grid { grid-template-columns: 1fr; }
            .footer-content { grid-template-columns: 1fr; text-align: center; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader"><div class="loader-pulse"><div></div><div></div></div></div>
    <header class="header">
        <div class="logo" id="logo"><span class="logo-trend">Trend</span>Pulse</div>
        <div class="ai-status-indicator" id="ai-status-indicator"><span id="ai-status-text"></span></div>
        <nav id="main-nav">
            <ul class="nav-links">
                <li><a href="#" id="nav-top-trends"></a></li>
                <li><a href="#" id="nav-trending-board"></a></li>
                <li id="nav-for-u" class="hidden"><a href="#"></a></li>
                <li><a href="#" id="nav-about"></a></li>
            </ul>
        </nav>
        <div style="display: flex; align-items: center; gap: 1rem;">
             <div class="nav-actions">
                <div class="language-switcher"><button class="btn btn-outline" id="language-toggle">VN</button></div>
                <!-- REMOVED: Sign In button -->
                <div id="user-menu"> <!-- Changed to always visible -->
                    <button class="btn btn-secondary" id="user-email-btn"></button>
                    <div class="dropdown" id="user-dropdown">
                        <div class="dropdown-header" id="dropdown-user-email"></div>
                        <!-- REMOVED/HIDDEN: Work/School option as accountType is always 'work' -->
                        <a href="#" class="dropdown-item hidden" id="dropdown-work-school"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg><span></span></a>
                        <a href="#" class="dropdown-item" id="dropdown-sign-out"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span></span></a>
                    </div>
                </div>
            </div>
            <button class="hamburger-menu" id="hamburger-menu"><span></span><span></span><span></span></button>
        </div>
    </header>
    
    <main class="main-container" id="main-view-container">
        <aside id="search-filter-panel">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span id="search-filter-title"></span></h3>
            <input type="text" id="search-input" placeholder="">
            <div id="hashtag-filter">
                <h4></h4>
                <div id="hashtag-list"></div>
            </div>
            <!-- NEW: Filters for main view (Region, Timeframe, Source) -->
            <div id="main-view-additional-filters" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                <h4 style="color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 0.25rem;" id="main-filter-title-region"></h4>
                <select id="main-region-filter" class="tb-filter-select">
                    <!-- Populated by JS -->
                </select>

                <h4 style="color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 0.25rem;" id="main-filter-title-timeframe"></h4>
                <select id="main-timeframe-filter" class="tb-filter-select">
                    <!-- Populated by JS -->
                </select>

                <h4 style="color: var(--text-muted-color); font-size: 0.9rem; margin-bottom: 0.25rem;" id="main-filter-title-source"></h4>
                <select id="main-source-filter" class="tb-filter-select">
                    <!-- Populated by JS -->
                </select>
            </div>
        </aside>
        <section class="trending-container">
            <div class="demo-banner"><h2></h2><p></p></div>
            <div class="trending-header">
                <div class="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg><span id="trending-header-text"></span></div>
                 <button class="btn btn-secondary hidden" id="clear-filter-btn"></button>
            </div>
            <div class="filter-buttons" id="filter-buttons"></div>
            <div id="trends-list"></div>
            <div id="trends-footer"><button class="btn btn-primary" id="load-more-btn"></button></div>
        </section>
    </main>

    <section class="for-u-container hidden" id="for-u-view-container">
        <div class="for-u-content">
            <div class="trending-header">
                <div class="trending-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg><span></span></div>
            </div>
            <div id="for-u-trends-list"></div>
            <div id="for-u-trends-footer"><button class="btn btn-primary" id="for-u-load-more-btn"></button></div>
        </div>
        <aside class="leaderboard-panel" id="for-u-leaderboard-panel">
             <h3></h3><div id="for-u-leaderboards"></div>
        </aside>
    </section>

    <section class="trending-board-container hidden" id="trending-board-view-container">
        <h2 id="tb-main-title" style="font-size: 2rem; margin-bottom: 1.5rem;"></h2>
        <div class="tb-header">
            <div class="tb-search-container" id="tb-search-container">
                <div class="tb-search-box">
                    <input type="text" id="tb-search-input" placeholder="">
                </div>
                <div class="tb-search-box compare">
                    <input type="text" id="tb-compare-input" placeholder="">
                </div>
            </div>
            <div class="tb-search-chips hidden" id="tb-search-chips-container"></div>
            <div class="tb-filters" style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));"> <!-- Adjusted grid columns -->
                <select id="tb-region-filter" class="tb-filter-select">
                    <!-- Options will be populated by JS -->
                </select>
                <select id="tb-category-filter" class="tb-filter-select">
                    <!-- Options will be populated by JS -->
                </select>
                <!-- Cập nhật: Kết hợp tb-timeframe-filter và tb-status-filter-container -->
                <select id="tb-status-select" class="tb-filter-select">
                    <option value="hottest"></option>
                    <option value="latest"></option>
                    <option value="outdated"></option>
                    <option value="predictive"></option>
                </select>
                <select id="tb-custom-timeframe-select" class="tb-filter-select">
                    <!-- Options populated by JS based on status -->
                </select>
            </div>
        </div>
        <div id="tb-default-view">
            <div class="tb-leaderboards-grid">
                <div class="tb-leaderboard">
                    <div class="tb-leaderboard-header" id="tb-topic-list-header"><span></span> <span></span></div>
                    <div class="tb-leaderboard-list" id="tb-topic-list"></div>
                </div>
                <div class="tb-leaderboard">
                    <div class="tb-leaderboard-header" id="tb-query-list-header"><span></span> <span></span></div>
                    <div class="tb-leaderboard-list" id="tb-query-list"></div>
                </div>
            </div>
        </div>
        <div id="tb-chart-container">
            <h4 id="tb-chart-title"></h4>
            <canvas id="hot-trends-chart"></canvas>
        </div>
        <!-- Container for User's Favorite Categories Chart -->
        <div id="user-trends-chart-container" class="hidden">
            <h4 id="user-trends-chart-title"></h4>
            <canvas id="user-trends-chart"></canvas>
        </div>
    </section>

    <div class="modal-overlay" id="preferences-modal"><div class="modal-content"><button class="modal-close" data-close="preferences-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p><div class="preferences-grid" id="preferences-grid"></div><div class="modal-actions"><button class="btn btn-primary" id="save-preferences-btn"></button></div></div></div>
    <div class="modal-overlay" id="premium-modal"><div class="modal-content"><button class="modal-close" data-close="premium-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p><div class="modal-actions"><button class="btn btn-primary" id="premium-login-btn"></button></div></div></div>
    <div class="modal-overlay" id="ai-insight-modal"><div class="modal-content"><button class="modal-close" data-close="ai-insight-modal">&times;</button><h3 class="modal-title" id="ai-insight-title"></h3><div id="ai-insight-body" class="modal-body"></div></div></div>
    
    <!-- NEW: Trend Overview Modal -->
    <div class="modal-overlay" id="trend-overview-modal">
        <div class="modal-content" id="trend-overview-content">
            <button class="modal-close" data-close="trend-overview-modal">&times;</button>
            <div id="trend-overview-body">
                <!-- Trend Card content will be inserted here by JavaScript -->
            </div>
        </div>
    </div>
    <!-- End NEW Trend Overview Modal -->

    <div class="modal-overlay" id="about-modal"><div class="modal-content"><button class="modal-close" data-close="about-modal">&times;</button><h3 class="modal-title"></h3><p class="modal-body"></p></div></div>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section"><h4 class="footer-title">TrendPulse</h4><p class="footer-description"></p></div>
            <div class="footer-section"><h4 class="footer-title"></h4><ul class="footer-links"><li><a href="#" id="footer-top-trends"></a></li><li><a href="#" id="footer-trending-board"></a></li><li><a href="#" id="footer-about"></a></a></li></ul></div>
            <div class="footer-section"><h4 class="footer-title"></h4><ul class="footer-links"><li><span id="feat-ai-analysis"></span></li><li><span id="feat-trend-prediction"></span></li><li><span id="feat-leaderboards"></span></li><li><span id="feat-personal-recommendations"></span></li></ul></div>
            <div class="footer-section"><h4 class="footer-title"></h4><div class="footer-contact"><p id="contact-email"></p><p id="contact-support"></p></div></div>
        </div>
        <div class="footer-bottom"><p></p></div>
    </footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let user = {
            isLoggedIn: true, email: 'guest@trendpulse.com', accountType: 'work',
            preferences: [], hasSetPreferences: false, followedTrends: [], tbSearchTerms: []
        };
        const TRENDS_PER_PAGE = 5;
        let displayedTrends = { main: 0, forU: 0 };
        let currentFilter = {
            type: 'category', value: 'All', searchTerm: '', hashtag: '',
            region: 'global', timeframe: '12m', source: 'All'
        };
        let currentView = localStorage.getItem('currentView') || 'main';
        let hotTrendsChart = null;
        let analysisChart = null;
        let userTrendsChart = null;
        let masterTrendsList = [];
        let categories = [];
        let regions = [];
        let sources = [];
        let currentLanguage = localStorage.getItem('lang') || 'vi';
        let currentTrendStatus = { status: 'hottest', customTimeframe: '7d' };

        // --- TRANSLATIONS ---
        const translations = {
            vi: {
                'Top Trends': 'Top Trends', 'Trending Board': 'Trending Board', 'For U': 'Dành cho bạn', 'For You': 'Dành cho bạn', 'About': 'Giới thiệu', 'Sign Out': 'Đăng xuất',
                'Welcome to TrendPulse': 'Chào mừng đến với TrendPulse', 'Discover what’s next. Act before the rest.': 'Khám phá tương lai. Hành động trước đối thủ.', 'Trending Now': 'Xu hướng hiện tại',
                'Load More': 'Tải thêm', 'View Source': 'Xem nguồn', 'Following': 'Đang theo dõi', '❤️ Follow': '❤️ Theo dõi', '🔍 Analyze': 'Phân tích', 'Deep Dive': 'Phân tích chuyên sâu', 'Summary': 'Tóm tắt',
                'Welcome! Set Your Preferences': 'Chào mừng! Thiết lập sở thích của bạn', "Select the categories you're interested in in for a personalized experience.": 'Chọn các danh mục bạn quan tâm để có trải nghiệm cá nhân hóa.', 'Save Preferences': 'Lưu sở thích',
                'Trending Board Dashboard': 'Bảng điều khiển Trending Board', 'Your Followed Trends': 'Xu Hướng Bạn Theo Dõi', 'Category Leaderboards': 'Bảng xếp hạng danh mục', 'About TrendPulse': 'Giới thiệu TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": 'Nền tảng cộng đồng để dự đoán, trực quan hóa và phân tích xu hướng mới nổi. Nhấp vào tiêu đề xu hướng để có thông tin chi tiết từ AI.',
                'Footer Description': 'Nền tảng phân tích và dự đoán xu hướng hàng đầu.', 'Quick Links': 'Liên kết nhanh', 'Features': 'Tính năng', 'AI Analysis': 'Phân tích AI', 'Trend Prediction': 'Dự đoán xu hướng', 'Leaderboards': 'Bảng xếp hạng', 'Personal Recommendations': 'Gợi ý cá nhân', 'Contact': 'Liên hệ', 'Email: info@trendpulse.com': 'Email: info@trendpulse.com', 'Support: support@trendpulse.com': 'Hỗ trợ: support@trendpulse.com', 'All rights reserved.': 'Tất cả quyền được bảo lưu.',
                'AI: Checking...': 'AI: Đang kiểm tra...', 'AI: Ready': 'AI: Sẵn sàng', 'AI: Unavailable': 'AI: Không khả dụng', 'AI: Connection error': 'AI: Lỗi kết nối', 'AI Deep Dive for': 'Phân tích Chuyên sâu cho', 'Analyzing trend...': 'Đang phân tích xu hướng...', 'Unable to analyze trend.': 'Không thể phân tích xu hướng.',
                'Interest Over Time': 'Mức Độ Quan Tâm', 'Find Trends': 'Tìm & Lọc Trends', 'Popular Tags': 'Thẻ Phổ Biến', 'Trending Topics': 'Chủ đề tìm kiếm', 'Trending Queries': 'Cụm từ tìm kiếm', 'All Categories': 'Tất cả danh mục',
                'Search by keyword...': 'Tìm kiếm theo từ khóa...', 'Add search term': 'Thêm cụm từ tìm kiếm', '+ Compare': '+ So sánh',
                'No trends found.': 'Không tìm thấy xu hướng nào.', 'No Title Available': 'Không có tiêu đề', 'No Description Available': 'Không có mô tả',
                'Technology': 'Công nghệ', 'Fashion': 'Thời trang', 'Gaming': 'Trò chơi', 'Finance': 'Tài chính', 'Health': 'Sức khỏe', 'Travel': 'Du lịch', 'Food': 'Ẩm thực', 'AI': 'Trí tuệ nhân tạo', 'News': 'Tin tức', 'Science': 'Khoa học', 'Music': 'Âm nhạc', 'Entertainment': 'Giải trí', 'Sports': 'Thể thao', 'Education': 'Giáo dục', 'Politics': 'Chính trị', 'Business': 'Kinh doanh',
                'Your Favorite Trends - Interest Over Time': 'Xu hướng yêu thích của bạn - Mức độ quan tâm theo thời gian',
                'Hottest': 'Hot nhất', 'Latest': 'Mới nhất', 'Outdated': 'Lỗi thời', 'Predictive': 'Dự đoán',
                'Last 1 hour': '1 giờ qua', 'Last 6 hours': '6 giờ qua', 'Last 24 hours': '24 giờ qua', 'Last 3 days': '3 ngày qua', 'Last 7 days': '7 ngày qua', 'Last 30 days': '30 ngày qua', 'Last 90 days': '90 ngày qua', 'Last 1 year': '1 năm qua',
                'Next 3 days': '3 ngày tới', 'Next 5 days': '5 ngày tới', 'Next 7 days': '7 ngày tới',
                'Region': 'Khu vực', 'Timeframe': 'Khung thời gian', 'Source': 'Nguồn', 'All Sources': 'Tất cả nguồn', 'Search Results': 'Kết quả tìm kiếm', 'Searching for': 'Đang tìm kiếm'
            },
            en: { 'Top Trends': 'Top Trends', 'Trending Board': 'Trending Board', 'For U': 'For U', 'For You': 'For You', 'About': 'About', 'Sign In': 'Sign In', 'Sign Out': 'Sign Out',
                'Sign in with Work/School': 'Sign in with Work/School', 'Sign in with Google': 'Sign in with Google',
                'Welcome to TrendPulse': 'Welcome to TrendPulse', 'Discover what’s next. Act before the rest.': 'Discover what’s next. Act before the rest.', 'Trending Now': 'Trending Now',
                'Show All Trends': 'Show All Trends', 'Load More': 'Load More', 'View Source': 'View Source', 'Following': 'Following', '❤️ Follow': '❤️ Follow', '🔍 Analyze': '🔍 Analyze',
                'Welcome! Set Your Preferences': 'Welcome! Set Your Preferences', "Select the categories you're interested in in for a personalized experience.": "Select the categories you're interested in for a personalized experience.", 'Save Preferences': 'Save Preferences', 'Premium Access Required': 'Premium Access Required',
                'Please sign in with a company or school email to view the Trending Board.': 'Please sign in with a company or school email to view the Trending Board.', 'Log In': 'Log In', 'Choose an account to continue to TrendPulse.': 'Choose an account to continue to TrendPulse.',
                'Trending Board Dashboard': 'Trending Board Dashboard', 'Top 5 Hot Trends': 'Top 5 Hot Trends', 'Your Followed Trends': 'Your Followed Trends', 'Category Leaderboards': 'Category Leaderboards', 'About TrendPulse': 'About TrendPulse',
                "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.": "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights.",
                'Footer Description': 'A leading platform for trend analysis and prediction, helping you stay ahead of the curve in the digital world.', 'Quick Links': 'Quick Links', 'Features': 'Features', 'AI Analysis': 'AI Analysis', 'Trend Prediction': 'Trend Prediction', 'Leaderboards': 'Leaderboards', 'Personal Recommendations': 'Personal Recommendations', 'Contact': 'Contact', 'Email: info@trendpulse.com': 'Email: info@trendpulse.com', 'Support: support@trendpulse.com': 'Support: support@trendpulse.com', 'All rights reserved.': 'All rights reserved.',
                'AI: Checking...': 'AI: Checking...', 'AI: Ready': 'AI: Ready', 'AI: Unavailable': 'AI: Unavailable', 'AI: Connection error': 'AI: Connection error', 'AI Insight for': 'AI Insight for', 'AI Analysis Summary for': 'AI Analysis Summary for', 'AI Deep Dive for': 'AI Deep Dive for', 'Analyzing trend...': 'Analyzing trend...', 'Unable to analyze trend.': 'Unable to analyze trend.', 'Trends for': 'Trends for', 'Success Score': 'Success Score', 'Summary': 'Summary', 'Interest Over Time': 'Interest Over Time', 'Engagement': 'Engagement', 'Find Trends': 'Find & Filter Trends', 'Popular Tags': 'Popular Tags', 'Trending Topics': 'Trending Topics', 'Trending Queries': 'Trending Queries', 'Growth': 'Growth', 'All Categories': 'All Categories',
                'Search by keyword...': 'Search by keyword...', 'Add search term': 'Add search term', '+ Compare': '+ Compare',
                'Vietnam': 'Vietnam', 'United States': 'United States', 'Global': 'Global',
                'Last 12 months': 'Last 12 months', 'Last 30 days': 'Last 30 days', 'Last 7 days': 'Last 7 days',
                'Rising': 'Rising', 'No trends found.': 'No trends found.',
                'No Title Available': 'No Title Available',
                'No Description Available': 'No Description Available',
                'Technology': 'Technology', 'Fashion': 'Fashion', 'Gaming': 'Gaming', 'Finance': 'Finance', 'Health': 'Health', 'Travel': 'Travel', 'Food': 'Food', 'AI': 'AI', 'News': 'News', 'Science': 'Science', 'Music': 'Music', 'Media': 'Media', 'Entertainment': 'Entertainment', 'Sports': 'Sports', 'Logistics': 'Logistics', 'Cybersecurity': 'Cybersecurity', 'Healthcare': 'Healthcare', 'Education': 'Education', 'Environment': 'Environment', 'Politics': 'Politics', 'Marketing': 'Marketing',
                'General': 'General', 'Toys': 'Toys', 'Sneakers': 'Sneakers', 'Beauty': 'Beauty', 'Lifestyle': 'Lifestyle', 'Family': 'Family', 'Cars': 'Cars', 'Archaeology': 'Archaeology',
                'Your Favorite Trends - Interest Over Time': 'Your Favorite Trends - Interest Over Time',
                'uk': 'United Kingdom', 'in': 'India', 'jp': 'Japan', 'de': 'Germany', 'fr': 'France', 'ca': 'Canada', 'au': 'Australia',
                'Hottest': 'Hottest', 'Latest': 'Latest', 'Outdated': 'Outdated', 'Predictive': 'Predictive',
                'Last 1 hour': 'Last 1 hour', 'Last 6 hours': 'Last 6 hours', 'Last 24 hours': 'Last 24 hours', 'Last 3 days': 'Last 3 days', 'Last 7 days': 'Last 7 days', 'Last 30 days': 'Last 30 days', 'Last 90 days': 'Last 90 days', 'Last 1 year': 'Last 1 year',
                'Next 3 days': 'Next 3 days', 'Next 5 days': 'Next 5 days', 'Next 7 days': 'Next 7 days',
                'Region': 'Region', 'Timeframe': 'Timeframe', 'Source': 'Source', 'All Sources': 'All Sources' }
        };

        const i18nBindings = [
            { selector: '#nav-top-trends', key: 'Top Trends' }, { selector: '#nav-trending-board', key: 'Trending Board' },
            { selector: '#nav-for-u a', key: 'For U' }, { selector: '#nav-about', key: 'About' },
            { selector: '#dropdown-sign-out span:last-child', key: 'Sign Out' },
            { selector: '.demo-banner h2', key: 'Welcome to TrendPulse' }, { selector: '.demo-banner p', key: 'Discover what’s next. Act before the rest.' },
            { selector: '#trending-header-text', key: 'Trending Now' }, { selector: '#load-more-btn', key: 'Load More' },
            { selector: '.for-u-container .trending-title-group span', key: 'For You' },
            { selector: '#preferences-modal .modal-title', key: 'Welcome! Set Your Preferences' }, { selector: '#preferences-modal .modal-body', key: "Select the categories you're interested in in for a personalized experience." },
            { selector: '#save-preferences-btn', key: 'Save Preferences' },
            { selector: '#tb-main-title', key: 'Trending Board Dashboard' }, { selector: '#for-u-leaderboard-panel h3', key: 'Category Leaderboards' },
            { selector: '#about-modal .modal-title', key: 'About TrendPulse' }, { selector: '#about-modal .modal-body', key: "A crowdsourced platform to predict, visualize, and analyze emerging trends. Click a trend's title to get AI-powered insights." },
            { selector: '.footer-section:nth-child(1) .footer-description', key: 'Footer Description' }, { selector: '.footer-section:nth-child(2) .footer-title', key: 'Quick Links' },
            { selector: '#footer-top-trends', key: 'Top Trends' }, { selector: '#footer-trending-board', key: 'Trending Board' },
            { selector: '#footer-about', key: 'About' }, { selector: '.footer-section:nth-child(3) .footer-title', key: 'Features' },
            { selector: '#feat-ai-analysis', key: 'AI Analysis' }, { selector: '#feat-trend-prediction', key: 'Trend Prediction' },
            { selector: '#feat-leaderboards', key: 'Leaderboards' }, { selector: '#feat-personal-recommendations', key: 'Personal Recommendations' },
            { selector: '.footer-section:nth-child(4) .footer-title', key: 'Contact' }, { selector: '#contact-email', key: 'Email: info@trendpulse.com' },
            { selector: '#contact-support', key: 'Support: support@trendpulse.com' },
            { selector: '#search-filter-title', key: 'Find Trends' }, { selector: '#hashtag-filter h4', key: 'Popular Tags' },
            { selector: '#tb-search-input', attr: 'placeholder', key: 'Add search term' },
            { selector: '#tb-compare-input', attr: 'placeholder', key: '+ Compare' },
            { selector: '#search-input', attr: 'placeholder', key: 'Search by keyword...' },
            { selector: '#user-trends-chart-title', key: 'Your Favorite Trends - Interest Over Time' },
            { selector: '#main-filter-title-region', key: 'Region' },
            { selector: '#main-filter-title-timeframe', key: 'Timeframe' },
            { selector: '#main-filter-title-source', key: 'Source' },
        ];

        // --- DOM ELEMENTS ---
        const DOM = {
            body: document.body, mainNav: document.getElementById('main-nav'), hamburgerMenu: document.getElementById('hamburger-menu'),
            logo: document.getElementById('logo'), userMenu: document.getElementById('user-menu'),
            userEmailBtn: document.getElementById('user-email-btn'), userDropdown: document.getElementById('user-dropdown'),
            dropdownSignOut: document.getElementById('dropdown-sign-out'),
            navTopTrends: document.getElementById('nav-top-trends'), navTrendingBoard: document.getElementById('nav-trending-board'),
            navForU: document.getElementById('nav-for-u'), navAbout: document.getElementById('nav-about'),
            mainViewContainer: document.getElementById('main-view-container'),
            forUViewContainer: document.getElementById('for-u-view-container'), trendingBoardContainer: document.getElementById('trending-board-view-container'),
            trendsList: document.getElementById('trends-list'), loadMoreBtn: document.getElementById('load-more-btn'),
            filterButtonsContainer: document.getElementById('filter-buttons'),
            searchInput: document.getElementById('search-input'), hashtagList: document.getElementById('hashtag-list'),
            tbSearchInput: document.getElementById('tb-search-input'), tbCompareInput: document.getElementById('tb-compare-input'),
            tbCategoryFilter: document.getElementById('tb-category-filter'), tbRegionFilter: document.getElementById('tb-region-filter'),
            tbSearchChipsContainer: document.getElementById('tb-search-chips-container'),
            tbDefaultView: document.getElementById('tb-default-view'), tbChartTitle: document.getElementById('tb-chart-title'),
            tbStatusSelect: document.getElementById('tb-status-select'), tbCustomTimeframeSelect: document.getElementById('tb-custom-timeframe-select'),
            trendOverviewModal: document.getElementById('trend-overview-modal'), trendOverviewBody: document.getElementById('trend-overview-body'),
            mainRegionFilter: document.getElementById('main-region-filter'),
            mainTimeframeFilter: document.getElementById('main-timeframe-filter'),
            mainSourceFilter: document.getElementById('main-source-filter'),
            clearFilterBtn: document.getElementById('clear-filter-btn'),
            forULoadMoreBtn: document.getElementById('for-u-load-more-btn'),
        };

        // --- UTILITY FUNCTIONS ---
        function t(key) { return (translations[currentLanguage]?.[key]) || key; }
        function openModal(modalId) { document.getElementById(modalId)?.classList.add('show'); }
        function closeModal(modalId) { document.getElementById(modalId)?.classList.remove('show'); }
        function debounce(func, delay) { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; }
        function formatNumber(n) { if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M'; if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K'; return String(n); }
        function truncateText(text = '', maxLength = 180) { if (!text || text.length <= maxLength) return text; const cut = text.slice(0, maxLength); return cut.slice(0, cut.lastIndexOf(' ', maxLength) || maxLength) + '…'; }
        
        // --- CORE LOGIC & RENDERING FUNCTIONS ---
        
        async function fetchLiveTrends() {
            const url = `/.netlify/builders/trends-builder`;
            console.log("Fetching MASTER list of trends from:", url);
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message || "Failed to fetch from builder.");
                masterTrendsList = Array.isArray(data.trends) ? data.trends : [];
                applyTrendOrdering();
                return masterTrendsList;
            } catch (e) {
                console.error('Failed to fetch master list:', e.message);
                if (DOM.trendsList) DOM.trendsList.innerHTML = `<p class="modal-body error-message">Could not load trends.</p>`;
                return [];
            }
        }
        
        async function analyzeTrendSecurely(trend, analysisType) {
            try {
                const response = await fetch('/.netlify/functions/analyze-trend', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trend, analysisType, language: currentLanguage }) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Server error: ${response.status}`);
                }
                const result = await response.json();
                if (!result.success) throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error("Secure analysis request failed:", error);
                throw error;
            }
        }
        
        function applyTrendOrdering() {
            const seenKeys = new Set(JSON.parse(localStorage.getItem('seenTrends') || '[]'));
            const makeKey = t => `${t.id}|${t.source}`.toLowerCase();
            const unseen = [], seen = [];
            masterTrendsList.forEach(trend => (seenKeys.has(makeKey(trend)) ? seen : unseen).push(trend));
            const shuffle = a => { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
            masterTrendsList = [...shuffle(unseen), ...seen];
        }

        function getLocalizedTrendText(trend) {
            const defaultTitle = t('No Title Available'), defaultDesc = t('No Description Available');
            let titleText = defaultTitle, descriptionText = defaultDesc, indicator = '';
            if (currentLanguage === 'vi') {
                if (trend.title_vi) { titleText = trend.title_vi; descriptionText = trend.description_vi || trend.description_en || defaultDesc; } 
                else if (trend.title_en) { titleText = trend.title_en; descriptionText = trend.description_en || defaultDesc; indicator = ' [EN]'; }
            } else {
                if (trend.title_en) { titleText = trend.title_en; descriptionText = trend.description_en || trend.description_vi || defaultDesc; } 
                else if (trend.title_vi) { titleText = trend.title_vi; descriptionText = trend.description_vi || defaultDesc; indicator = ' [VI]'; }
            }
            return { title: titleText + indicator, description: descriptionText };
        }
        
        function createTrendCardContent(trend) {
            if (!trend) return '';
            const { title, description } = getLocalizedTrendText(trend);
            const isFollowed = user.followedTrends.includes(trend.id);
            return `
                <div class="trend-card-header">
                    <h3 class="trend-title">${DOMPurify.sanitize(title)}</h3>
                    <div class="trend-meta">
                        <span>by ${DOMPurify.sanitize(trend.submitter || 'Anon')}</span>
                        <span class="trend-meta-date">on ${new Date(trend.date).toLocaleDateString(currentLanguage)}</span>
                    </div>
                </div>
                <p class="trend-description">${DOMPurify.sanitize(description)}</p>
                <div class="trend-footer">
                    <div class="trend-tags">
                        <span class="tag category">${t(trend.category)}</span>
                        ${(trend.tags || []).map(tag => `<span class="tag hashtag" data-tag="${DOMPurify.sanitize(tag)}">#${DOMPurify.sanitize(tag)}</span>`).join('')}
                    </div>
                    <div class="trend-actions">
                        <a href="${DOMPurify.sanitize(trend.source || '#')}" target="_blank" rel="noopener noreferrer" class="btn btn-outline">${t('View Source')}</a>
                        <button class="btn btn-outline btn-summary">${t('Summary')}</button>
                        <button class="btn btn-outline analyze-trend-btn">${t('🔍 Analyze')}</button>
                        <button class="btn btn-follow ${isFollowed ? 'followed' : ''}">${isFollowed ? t('Following') : t('❤️ Follow')}</button>
                    </div>
                </div>`;
        }
        
        async function createHotTrendsChart(newSearchTerm = null, compareTerm = null) {
            const canvas = document.getElementById('hot-trends-chart');
            if (!canvas) return;
            if (hotTrendsChart) hotTrendsChart.destroy();
            
            const chartContext = canvas.getContext('2d');

            if (newSearchTerm) {
                const term = newSearchTerm.trim();
                if (term && !user.tbSearchTerms.includes(term)) user.tbSearchTerms.push(term);
            }
            if (compareTerm) {
                const term = compareTerm.trim();
                if (term && !user.tbSearchTerms.includes(term)) user.tbSearchTerms.push(term);
            }

            if (DOM.tbSearchChipsContainer) {
                DOM.tbSearchChipsContainer.innerHTML = user.tbSearchTerms.map(term => `<span class="tb-search-chip">${truncateText(term, 20)}<button class="tb-search-chip-remove" data-term="${term}">&times;</button></span>`).join('');
                DOM.tbSearchChipsContainer.classList.toggle('hidden', user.tbSearchTerms.length === 0);
            }

            const chartTitleEl = DOM.tbChartTitle;
            let trendsToDraw = [];
            
            if (user.tbSearchTerms.length > 0) {
                if (DOM.tbDefaultView) DOM.tbDefaultView.classList.add('hidden');
                if (chartTitleEl) chartTitleEl.innerHTML = `<div class="loading-spinner" style="display: inline-block; vertical-align: middle; margin-right: 10px;"></div> ${t('Searching for')} "${user.tbSearchTerms.join(', ')}"...`;
                
                try {
                    const searchPromises = user.tbSearchTerms.map(term => 
                        fetch(`/.netlify/functions/fetch-trends?searchTerm=${encodeURIComponent(term)}`).then(res => res.json())
                    );
                    const results = await Promise.all(searchPromises);
                    let allSearchResults = [];
                    results.forEach(result => {
                        if (result.success && Array.isArray(result.trends)) allSearchResults.push(...result.trends);
                    });
                    const uniqueTrendsMap = new Map();
                    allSearchResults.forEach(trend => uniqueTrendsMap.set(trend.id, trend));
                    trendsToDraw = Array.from(uniqueTrendsMap.values()).sort((a, b) => (b.hotnessScore || 0) - (a.hotnessScore || 0)).slice(0, 10);
                    if (chartTitleEl) chartTitleEl.textContent = `${t('Search Results')} - ${t('Interest Over Time')}`;
                } catch (error) {
                    console.error("Live search failed:", error);
                    if (chartTitleEl) chartTitleEl.textContent = t('Search failed. Please try again.');
                    trendsToDraw = [];
                }
            } else {
                const selectedCategory = DOM.tbCategoryFilter.value;
                const selectedRegion = DOM.tbRegionFilter.value;
                const status = DOM.tbStatusSelect.value;
                const customTimeframe = DOM.tbCustomTimeframeSelect.value;
                
                let filteredTrends = masterTrendsList.filter(trend =>
                    (selectedRegion === 'global' || trend.region === selectedRegion) &&
                    (selectedCategory === 'All' || trend.category === selectedCategory)
                );

                if (status !== 'predictive') {
                    filteredTrends = filteredTrends.filter(trend => isTrendRelevantForTimeframe(trend, customTimeframe));
                } else {
                    filteredTrends = filteredTrends.filter(trend => isTrendRelevantForTimeframe(trend, '7d'));
                }
                
                if (status === 'outdated') {
                    const now = new Date();
                    const cutoffDate = new Date(new Date().setDate(now.getDate() - 7));
                    filteredTrends = filteredTrends.filter(trend => new Date(trend.date) < cutoffDate);
                }
                
                let sortedTrends = [];
                switch (status) {
                    case 'hottest': case 'predictive':
                        sortedTrends = [...filteredTrends].sort((a, b) => (b.hotnessScore || 0) - (a.hotnessScore || 0)); break;
                    case 'latest':
                        sortedTrends = [...filteredTrends].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); break;
                    case 'outdated':
                        sortedTrends = [...filteredTrends].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()); break;
                    default:
                        sortedTrends = [...filteredTrends].sort((a, b) => (b.hotnessScore || 0) - (a.hotnessScore || 0));
                }

                trendsToDraw = sortedTrends.slice(0, 5);
                if (DOM.tbDefaultView) DOM.tbDefaultView.classList.remove('hidden');
                renderTBDashboard(customTimeframe);
                if (chartTitleEl) chartTitleEl.textContent = `${t(status)} - ${t('Interest Over Time')}`;
            }
            
            const customTimeframeForChart = user.tbSearchTerms.length > 0 ? '7d' : DOM.tbCustomTimeframeSelect.value;
            const labels = generateChartLabels(customTimeframeForChart);
            const palette = getColorPalette(trendsToDraw.length || 5);
            const datasets = trendsToDraw.map((trendItem, i) => {
                const color = palette[i % palette.length].stroke;
                const gradient = chartContext.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, `${color}40`);
                gradient.addColorStop(1, `${color}00`);

                return {
                    label: truncateText(getLocalizedTrendText(trendItem).title, 30),
                    data: generateSeriesForTimeframe(trendItem, labels, customTimeframeForChart),
                    borderColor: color, backgroundColor: gradient, fill: true, tension: 0.4,
                    pointRadius: 2, pointHoverRadius: 6, pointBackgroundColor: color,
                    trendId: trendItem.id
                }
            });

            if (datasets.length > 0) {
                hotTrendsChart = new Chart(chartContext, {
                    type: 'line', data: { labels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', labels: { color: '#8a8da0', usePointStyle: true, boxWidth: 8 },
                                onClick: (e, legendItem, legend) => {
                                    const index = legendItem.datasetIndex;
                                    const trendId = legend.chart.data.datasets[index].trendId;
                                    if (trendId) {
                                        const trend = masterTrendsList.find(t => t.id === trendId);
                                        if (trend) openTrendOverviewModal(trend);
                                    }
                                }
                            }
                        },
                        scales: { /* ... */ }
                    }
                });
            } else {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                if (chartTitleEl) chartTitleEl.textContent = t('No trends found.');
            }
            renderUserTrendsChart(customTimeframeForChart);
        }

        function handleInteraction(e) {
            const targetElement = e.target;
            const trendCard = targetElement.closest('.trend-card');
            const leaderboardItem = targetElement.closest('#tb-topic-list li, #tb-query-list li, #for-u-leaderboards li');
            let trendId = trendCard?.dataset.trendId || leaderboardItem?.dataset.trendId;

            if (targetElement.matches('.tag.hashtag')) {
                currentFilter.type = 'hashtag';
                currentFilter.hashtag = targetElement.dataset.tag;
                switchView('main');
                closeModal('trend-overview-modal');
                return; 
            }
            if (!trendId) return;
            const trend = masterTrendsList.find(t => t.id === trendId);
            if (!trend) return;
            
            if (targetElement.closest('.btn-follow')) {
                // handle follow logic here
            } else if (targetElement.closest('.btn-summary') || targetElement.closest('.analyze-trend-btn')) {
                const analysisType = targetElement.closest('.btn-summary') ? 'summary' : 'detailed';
                openAIInsightModal(trend, analysisType);
            } else {
                openTrendOverviewModal(trend);
            }
        }

        async function initializeApp() {
            applyTranslations();
            updateLanguageToggleUI();
            
            if (DOM.mainViewContainer) DOM.mainViewContainer.classList.toggle('hidden', currentView !== 'main');
            if (DOM.forUViewContainer) DOM.forUViewContainer.classList.toggle('hidden', currentView !== 'forU');
            if (DOM.trendingBoardContainer) DOM.trendingBoardContainer.classList.toggle('hidden', currentView !== 'trendingBoard');

            await fetchLiveTrends();
            
            regions = [...new Set(masterTrendsList.map(t => t.region))].filter(Boolean).sort();
            populateRegionsFilter(DOM.mainRegionFilter);
            populateRegionsFilter(DOM.tbRegionFilter);
            categories = [...new Set(masterTrendsList.map(t => t.category))].sort();
            populateCategoryFilters();
            populateMainTimeframeFilter();
            populateSourceFilter();
            populateHashtagFilters();
            
            updateAuthUI();
            checkAIStatus();
            updateActiveNav(currentView);
            updateClearFilterButtonVisibility();

            if (!user.hasSetPreferences) {
                populatePreferenceCheckboxes();
                openModal('preferences-modal');
            } else if (currentView === 'trendingBoard') {
                await createHotTrendsChart();
            } else {
                displayTrends();
            }

            document.getElementById('loader')?.classList.add('loader-hidden');
        }
        
        // --- EVENT LISTENERS ---
        DOM.hamburgerMenu?.addEventListener('click', () => {
            DOM.mainNav?.classList.toggle('nav-active');
            DOM.hamburgerMenu.classList.toggle('active');
        });
        
        DOM.logo?.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
        DOM.navTopTrends?.addEventListener('click', (e) => { e.preventDefault(); switchView('main'); });
        DOM.navForU?.addEventListener('click', (e) => { e.preventDefault(); switchView('forU'); });
        DOM.userEmailBtn?.addEventListener('click', () => DOM.userDropdown?.classList.toggle('show'));
        DOM.dropdownSignOut?.addEventListener('click', (e) => {
            e.preventDefault();
            // Implement sign out logic, e.g., clear user data and refresh
            user = { isLoggedIn: false, email: null, accountType: null, preferences: [], hasSetPreferences: false, followedTrends: [], tbSearchTerms: [] };
            localStorage.clear();
            window.location.reload();
        });
        DOM.navAbout?.addEventListener('click', (e) => { e.preventDefault(); openModal('about-modal'); });
        DOM.navTrendingBoard?.addEventListener('click', (e) => { e.preventDefault(); switchView('trendingBoard'); });
        
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay').id)));
        
        DOM.loadMoreBtn?.addEventListener('click', loadMoreTrends);
        DOM.forULoadMoreBtn?.addEventListener('click', loadMoreTrends);
        
        document.getElementById('save-preferences-btn')?.addEventListener('click', () => {
             user.preferences = [...document.querySelectorAll('#preferences-grid input:checked')].map(cb => cb.value);
             user.hasSetPreferences = true;
             localStorage.setItem('userPreferences', JSON.stringify(user.preferences));
             localStorage.setItem('userHasSetPreferences', 'true');
             closeModal('preferences-modal');
             switchView('forU');
        });

        [document.getElementById('trends-list'), document.getElementById('for-u-trends-list'), document.getElementById('for-u-leaderboards'), document.getElementById('tb-topic-list'), document.getElementById('tb-query-list')].forEach(list => {
            if (list) list.addEventListener('click', handleInteraction);
        });
        
        DOM.filterButtonsContainer?.addEventListener('click', e => {
            if (e.target.matches('.filter-btn')) {
                currentFilter.type = 'category';
                currentFilter.value = e.target.dataset.filter;
                updateUIForFilter();
            }
        });

        DOM.mainRegionFilter?.addEventListener('change', () => { currentFilter.region = DOM.mainRegionFilter.value; updateUIForFilter(); });
        DOM.mainTimeframeFilter?.addEventListener('change', () => { currentFilter.timeframe = DOM.mainTimeframeFilter.value; updateUIForFilter(); });
        DOM.mainSourceFilter?.addEventListener('change', () => { currentFilter.source = DOM.mainSourceFilter.value; updateUIForFilter(); });
        
        DOM.clearFilterBtn?.addEventListener('click', clearMainViewFilters);
        
        DOM.searchInput?.addEventListener('input', debounce(() => { currentFilter.searchTerm = DOM.searchInput.value; displayTrends(); }, 300));
        
        DOM.hashtagList?.addEventListener('click', e => {
            if (e.target.matches('.hashtag-btn')) {
                const hashtag = e.target.dataset.hashtag;
                currentFilter.hashtag = currentFilter.hashtag === hashtag ? '' : hashtag;
                updateUIForFilter();
            }
        });

        DOM.tbSearchInput?.addEventListener('keypress', e => { if (e.key === 'Enter' && e.target.value.trim()) { createHotTrendsChart(e.target.value.trim()); e.target.value = ''; } });
        DOM.tbCompareInput?.addEventListener('keypress', e => { if (e.key === 'Enter' && e.target.value.trim()) { createHotTrendsChart(null, e.target.value.trim()); e.target.value = ''; } });
        
        DOM.tbSearchChipsContainer?.addEventListener('click', e => {
            if (e.target.matches('.tb-search-chip-remove')) {
                user.tbSearchTerms = user.tbSearchTerms.filter(t => t !== e.target.dataset.term);
                createHotTrendsChart();
            }
        });
        
        DOM.tbCategoryFilter?.addEventListener('change', () => createHotTrendsChart());
        DOM.tbRegionFilter?.addEventListener('change', () => createHotTrendsChart());
        
        DOM.tbStatusSelect?.addEventListener('change', () => {
            currentTrendStatus.status = DOM.tbStatusSelect.value;
            populateCustomTimeframeOptions(currentTrendStatus.status);
            createHotTrendsChart();
        });
        
        DOM.tbCustomTimeframeSelect?.addEventListener('change', () => {
            currentTrendStatus.customTimeframe = DOM.tbCustomTimeframeSelect.value;
            createHotTrendsChart();
        });
        
        DOM.trendOverviewBody?.addEventListener('click', e => {
            const targetElement = e.target;
            const trendId = DOM.trendOverviewBody.dataset.currentTrendId;
            const trend = masterTrendsList.find(t => t.id === trendId);
            if (!trend) return;
            if (targetElement.closest('.btn-summary') || targetElement.closest('.analyze-trend-btn') || targetElement.closest('.trend-title')) {
                const analysisType = targetElement.closest('.btn-summary') ? 'summary' : 'detailed';
                openAIInsightModal(trend, analysisType);
            } else if (targetElement.closest('.btn-follow')) {
                handleInteraction(e);
            } else if (targetElement.matches('.tag.hashtag')) {
                currentFilter.hashtag = targetElement.dataset.tag;
                switchView('main');
                closeModal('trend-overview-modal');
            }
        });
        
        document.getElementById('language-toggle')?.addEventListener('click', async () => {
            currentLanguage = currentLanguage === 'vi' ? 'en' : 'vi';
            localStorage.setItem('lang', currentLanguage);
            applyTranslations();
            updateLanguageToggleUI();
            await fetchLiveTrends();
            if (currentView === 'trendingBoard') {
                createHotTrendsChart();
            } else {
                displayTrends();
            }
        });
        
        initializeApp();
    });
</script>





